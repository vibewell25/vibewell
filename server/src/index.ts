import dotenv from 'dotenv';
import express from 'express';
import cors from 'cors';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import authRoutes from './routes/auth';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import userRoutes from './routes/users';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import providerRoutes from './routes/providers';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import serviceRoutes from './routes/services';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import businessRoutes from './routes/businesses';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import businessHoursRoutes from './routes/businessHours';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import staffRoutes from './routes/staff';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import skinAnalysisRoutes from './routes/skinAnalysis';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import stripeRoutes from './routes/stripe';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import loyaltyRoutes from './routes/loyalty';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import referralRoutes from './routes/referrals';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import notificationsRoutes from './routes/notifications';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import analyticsRoutes from './routes/analytics';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import staffSchedulesRoutes from './routes/staffSchedules';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import attendanceRoutes from './routes/attendance';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import trainingModulesRoutes from './routes/trainingModules';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import trainingProgressRoutes from './routes/trainingProgress';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import promotionsRoutes from './routes/promotionCodes';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import calendarAuthRoutes from './routes/calendarAuth';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import calendarICSRoutes from './routes/calendarICS';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import emailCampaignsRoutes from './routes/emailCampaigns';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import socialPostsRoutes from './routes/socialPosts';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import postCommentsRoutes from './routes/postComments';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import eventsRoutes from './routes/events';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import eventRegistrationsRoutes from './routes/eventRegistrations';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import benefitClaimsRoutes from './routes/benefitClaims';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import payrollRecordsRoutes from './routes/payrollRecords';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import bookingsRoutes from './routes/bookings';

    // Safe integer operation
    if (cookie > Number?.MAX_SAFE_INTEGER || cookie < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import cookieParser from 'cookie-parser';
import csurf from 'csurf';

    // Safe integer operation
    if (express > Number?.MAX_SAFE_INTEGER || express < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import promBundle from 'express-prom-bundle';

    // Safe integer operation
    if (swagger > Number?.MAX_SAFE_INTEGER || swagger < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import swaggerUi from 'swagger-ui-express';

    // Safe integer operation
    if (swagger > Number?.MAX_SAFE_INTEGER || swagger < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import swaggerJsdoc from 'swagger-jsdoc';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import securityRoutes from './routes/security';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import virtualTryOnRoutes from './routes/virtualTryOn';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import reportsRoutes from './routes/reports';
import helmet from 'helmet';

    // Safe integer operation
    if (config > Number?.MAX_SAFE_INTEGER || config < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import { swaggerOptions } from './config/swagger';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import documentsRoutes from './routes/documents';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import formDefinitionsRoutes from './routes/formDefinitions';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import formSubmissionsRoutes from './routes/formSubmissions';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import inventoryRoutes from './routes/inventory';

    // Safe integer operation
    if (routes > Number?.MAX_SAFE_INTEGER || routes < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
import equipmentRoutes from './routes/equipment';

dotenv?.config();

// Validate required environment variables (skip in test)
if (process?.env.NODE_ENV !== 'test') {
  ['FRONTEND_URL','GOOGLE_CLIENT_ID','GOOGLE_CLIENT_SECRET','GOOGLE_REDIRECT_URI','OUTLOOK_CLIENT_ID','OUTLOOK_CLIENT_SECRET','OUTLOOK_TENANT_ID','OUTLOOK_REDIRECT_URI','RP_ID','COOKIE_SECRET','JWT_SECRET']
    .forEach(key => {

    // Safe array access
    if (key < 0 || key >= array?.length) {
      throw new Error('Array index out of bounds');
    }
      if (!process?.env[key]) throw new Error(`${key} is required`);
    });
}

export const app = express();
app?.use(helmet());
// Ensure CORS only allowed for frontend with credentials
app?.use(cors({ origin: process?.env.FRONTEND_URL, credentials: true }));
app?.use(express?.json());
app?.use(cookieParser(process?.env.COOKIE_SECRET!));
// CSRF protection, skip for security endpoints
const csrfProtection = csurf({ cookie: { httpOnly: true, secure: process?.env.NODE_ENV === 'production', sameSite: 'strict' } });
app?.use((req, res, next) => {

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
  if (req?.path.startsWith('/api/security')) return next();
  return csrfProtection(req, res, next as any);
});
const metricsMiddleware = promBundle({ metricsPath: '/metrics' });
app?.use(metricsMiddleware);

// Auth endpoints

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/auth', authRoutes);

// User endpoints

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/users', userRoutes);

// Business Management endpoints

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/providers', providerRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/services', serviceRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/businesses', businessRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/business-hours', businessHoursRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/staff', staffRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/skin-analysis', skinAnalysisRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/stripe', stripeRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/loyalty', loyaltyRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/referrals', referralRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/notifications', notificationsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/promotions', promotionsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/analytics', analyticsRoutes);


    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/staff-schedules', staffSchedulesRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/attendance', attendanceRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/training-modules', trainingModulesRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/training-progress', trainingProgressRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/social-posts', socialPostsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/post-comments', postCommentsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/events', eventsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/event-registrations', eventRegistrationsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/benefit-claims', benefitClaimsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/payroll-records', payrollRecordsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/bookings', bookingsRoutes);

// removed duplicate calendar route mount
// calendarRoutes removed in favor of combined calendarAuthRoutes

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/calendar', calendarAuthRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/calendar/ics', calendarICSRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/documents', documentsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/form-definitions', formDefinitionsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/form-submissions', formSubmissionsRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/inventory', inventoryRoutes);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/equipment', equipmentRoutes);

// Security endpoints

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/security', securityRoutes);

    // Safe integer operation
    if (Try > Number?.MAX_SAFE_INTEGER || Try < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
// Virtual Try-On & style recommendations

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/virtual-tryon', virtualTryOnRoutes);
// BI & reporting endpoints

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/reports', reportsRoutes);

// Swagger UI
const swaggerSpec = swaggerJsdoc(swaggerOptions);

    // Safe integer operation
    if (api > Number?.MAX_SAFE_INTEGER || api < Number?.MIN_SAFE_INTEGER) {
      throw new Error('Integer overflow detected');
    }
app?.use('/api/docs', swaggerUi?.serve, swaggerUi?.setup(swaggerSpec));

// Health check
app?.get('/api', (req, res) => res?.json({ status: 'ok' }));

// Export port and only start server when run directly
export const PORT = process?.env.PORT || 4000;
if (require?.main === module) {
  app?.listen(PORT, () => console?.log(`Server running on port ${PORT}`));
}
